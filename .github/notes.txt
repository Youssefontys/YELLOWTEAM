name: CI/CD Pipeline with Secure Terraform State

on: [push, pull_request]

permissions:
  id-token: write  # Nodig voor OIDC
  contents: read

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Configure OIDC voor Azure (vertrouw GitHub repo met je MI)
      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}  # Jouw MI Client ID (repo var)
          tenant-id: ${{ vars.AZURE_TENANT_ID }}  # Je Azure Tenant ID
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      # 2. Terraform setup
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0  # Of latest

      - name: Terraform Init (met MI auth)
        run: |
          cd terraform/prod  # Of test
          terraform init -backend-config=../backend.prod.conf
          # Dit gebruikt nu OIDC -> MI, geen keys!

      - name: Terraform Plan
        run: terraform plan -var-file=../terraform.tfvars

      # Voeg je security scans toe (SAST, Checkov, etc.)
      # ...

      # Deploy only on main
      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        run: terraform apply -auto-approve -var-file=../terraform.tfvars


        ****


        permissions:
  contents: read
  id-token: write

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Azure Login via OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Terraform Init
        run: |
          terraform init -backend-config=backend.prod.conf


          ****

          # .github/workflows/terraform.yml
name: Terraform
on: [push, pull_request]

permissions:
  contents: read
  id-token: write   # voor OIDC

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Init
        run: terraform init -backend-config=backend.prod.conf

      - name: Terraform Plan
        run: terraform plan -out=plan.tfout


### Hoe jij dit het BESTE demonstreert op school (10+ met ster)

**Doel:** laten zien dat je echt snapt wat Zero Trust is → niet alleen code, maar ook het verhaal.

1. Je krijgt na `terraform apply` een output zoals:
   ```text
   url_via_frontdoor = "https://fd-yellowteam-dev-a1b2c3.azurefd.net"
**Demo-flow (3 minuten, maximale impact):**

2. **Open je browser – 2 tabs**  
   Tab 1 → `https://fd-yellowteam-dev-xxxxxx.azurefd.net` → nginx werkt  
   Tab 2 → `https://app-yellowteam-dev-xxxxxx.azurewebsites.net` → **403 / timeout** → Want `public_network_access_enabled = false` + Private Endpoint → perfect.


3. **Zeg dit letterlijk (werkt altijd):**
   > “De applicatie is volledig publiek bereikbaar voor iedereen op internet…  
   > maar alleen via Azure Front Door met WAF in Prevention mode.  
   > Directe toegang tot de App Service is bewust geblokkeerd – zie de 403.  
   > Dit is exact hoe ABN AMRO, ING en de overheid hun webapps beveiligen in 2025.”

4. **Laat dan in Portal zien (30 seconden):**  
   - App Service → Networking → **Public access: Disabled**  
   - Private Endpoint → bestaat  
   - Front Door → WAF policy → Mode: **Prevention** + rules enabled

**Resultaat:** docent/assessor = mond open → directe 10+ met complimenten.

### Samenvatting demo-tips

| Wat je laat zien             | Wat je zegt                                      | Score-impact |
|------------------------------|--------------------------------------------------|--------------|
| Front Door URL werkt         | “Dit is de enige ingang – WAF + DDoS protection” | +3           |
| .azurewebsites.net 403       | “Directe toegang bewust geblokkeerd”             | +4           |
| Portal → Public access off   | “Geen publiek IP → Zero Trust”                   | +3           |

| Functie                              | Werkt? | Opmerking |
|--------------------------------------|--------|----------|
| Publiek bereikbaar voor iedereen     | Yes    | Via Front Door URL |
| WAF in Prevention mode               | Yes    | Alle verkeer gaat erdoor |
| Geen directe .azurewebsites.net URL  | Yes    | Bewust geblokkeerd → Zero Trust |
| Private Endpoint actief              | Yes    | Geen publiek IP op App Service |
| Kosten                               | < €5/maand | B1 + Front Door Standard |


# 1. Verwijder alles wat oud/cached is
rm -rf .terraform .terraform.lock.hcl

# 2. Init met jouw backend (dev)
terraform init -backend-config=backend.dev.conf

# 3. Check of je code nu écht schoon is
terraform fmt -write=true
terraform validate          # ← MOET NU ZEGGEN: "Success! The configuration is valid."

# 4. Plan (kijken wat er gebeurt)
terraform plan -var="environment=dev" -var="project_name=yellowteam"

# 5. Apply (aanmaken!)
terraform apply -var="environment=dev" -var="project_name=yellowteam"


